<!DOCTYPE html>
<html lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div layout:fragment="content" th:remove="tag">
    <link rel="stylesheet" th:href="@{/vendor/highlight/vs2015.min.css}">
    <script th:src="@{/vendor/highlight/highlight.min.js}"></script>
    <script th:src="@{/vendor/highlight/json.min.js}"></script>
    <script>hljs.initHighlightingOnLoad();</script>


    <div class="row mx-auto">
        <div class="col-md-4 my-2">
            <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text">Grafana Dashboard</div>
                </div>
                <select id="dashboard-select" name="dashboard-select" class="form-control">
                    <option value="" selected disabled hidden> --- dashboard select ---</option>
                    <option th:each="dashboard : ${dashboards}"
                            th:value="${dashboard?.uid}" th:text="${dashboard?.title}">dashboard
                    </option>
                </select>
            </div>
        </div>
        <div class="col-md-4 my-2">
            <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text">Grafana Dashboard</div>
                </div>
                <select id="panel-select" name="dashboard-select" class="form-control">
                    <option value="" selected disabled hidden> --- panel select ---</option>
                </select>
            </div>
        </div>
    </div>
    <div id="input-area" class="row mx-auto">
    </div>
    <div id="panel-area" class="row mx-auto">
    </div>
    <div class="row mx-auto">
        <div class="col-md my-2">
            <span>Panel 데이터</span>
            <pre>
                <code id="panel-data-area" class="json"></code>
            </pre>
        </div>
    </div>
    <div class="row mx-auto">
        <div class="col-md my">
            <span>Dashboard 정보</span>
            <pre>
                <code id="dashboard-data-area" class="json">{"test" : "test", "test1" : "test1"}</code>
            </pre>
        </div>
    </div>
    <script>
        $(function () {

            let panelUrl = new Map();
            let panelQueryMap = new Map();
            let variableMap;
            let dashboardUrl;

            const $dashboardSelect = $('#dashboard-select'),
                $panelSelect = $('#panel-select'),
                $dashboardDataArea = $('#dashboard-data-area'),
                $panelDataArea = $('#panel-data-area'),
                $inputArea = $('#input-area'),
                $panelArea = $('#panel-area');


            $dashboardSelect.on('change', function (evt) {
                console.log($(this).val());

                if ($(this).val() === '-1') {
                    return;
                }

                $.get("/grafana/dashboards/" + $(this).val())
                    .done(function (data) {
                        $dashboardDataArea.text(JSON.stringify(data, null, '  '));
                        document.querySelectorAll('pre > code').forEach(function (el) {
                            hljs.highlightBlock(el);
                        });
                    })
                    .fail(function () {
                        alert("조회 실패")
                    })
                    .always(function (data) {
                        dashboardUrl = data.meta.host + data.meta.panel_url;
                        $panelSelect.empty();
                        let panels = data.dashboard.panels;
                        let templating = data.dashboard.templating;

                        panelQueryMap.clear();
                        panelUrl.clear();

                        generateVariable($inputArea, templating)
                        generatePanelList($panelSelect, panels)
                        generatePanel($panelArea, data.meta.host + data.meta.panel_url, panels);
                    });

                function generateVariable(selector, templateVariable) {
                    selector.text('');
                    variableMap = new Map(Object.entries(templateVariable));
                    for (let [key, varItem] of variableMap) {
                        let select = "<div class=\"col-md-4 my-2\"><div class=\"input-group\"><div class=\"input-group-prepend\"><div class=\"input-group-text\">"
                            + varItem.label + "</div></div>"
                            + "<select id='" + "var-" + key + "' name='" + "var-" + key + "' class='form-control'>";

                        if (varItem.includeAll) {
                            // 프로메테우스 api에서는 item.allValue를 이용해야 함.
                            // select += "<option value='" + varItem.allValue + "'>All</option>";
                            select += "<option value='All'>All</option>";
                        }

                        if (Array.isArray(varItem.values) && varItem.values !== null) {
                            for (let value of varItem.values) {
                                select += "<option value='" + value + "'>" + value + "</option>";
                            }
                        }
                        select += "</select>" + "</div></div>";
                        selector.append(select);
                    }
                }

                function generatePanelList(selector, panelsData) {
                    panelsData.forEach(function (panel) {
                        if (Array.isArray(panel.panels)) {
                            panel.panels.forEach(function (subPanel) {
                                $panelSelect.append("<option value='" + subPanel.id + "'>" + subPanel.title + "</option>");
                                panelQueryMap.set(subPanel.id, subPanel.targets);
                            });
                            return;
                        }
                        if (panel.type === "row") {
                            return;
                        }
                        selector.append("<option value='" + panel.id + "'>" + panel.title + "</option>");
                        panelQueryMap.set(panel.id, panel.targets);
                    });

                }

                function generatePanel(selector, panelUrl, panelsData) {
                    selector.text('');
                    let cardTag = "<div class=\"row\">";
                    let count = 0;
                    panelsData.forEach(function (item) {

                        if (count !== 0 && count % 4 === 0) {
                            cardTag += "</div>";
                            cardTag += "<div class=\"row\">";
                        }

                        if (Array.isArray(item.panels)) {
                            cardTag = getPanelRowHtml(item, cardTag);
                            item.panels.forEach(function (subItem) {
                                cardTag = getPanelHtml(panelUrl, subItem, cardTag);
                            })
                            count++;
                            return;
                        }
                        if (item.type === "row") {
                            cardTag = getPanelRowHtml(item, cardTag);
                        }
                        cardTag = getPanelHtml(panelUrl, item, cardTag);
                        count++;
                    });
                    selector.append(cardTag + "</div>");
                }

                function getPanelRowHtml(panel, cardTag) {
                    cardTag += "<div class=\"row\"><div class=\"main_title_top col-xs-12\" ><i class=\"feather icon-chevrons-right\"></i>";
                    cardTag += panel.title;
                    cardTag += "</div></div>";
                    return cardTag;
                }

                function getPanelHtml(url, panel, cardTag) {
                    cardTag += "<div class=\"col-xs-12 col-md-12 col-lg-3\" style=\"padding-right:0px;\">\n" +
                        "    <div class=\"col-xs-12 box_panel p-2\" style=\"padding:0px;\">\n" +
                        "            <div class=\"embed-responsive embed-responsive-16by9\">";
                    cardTag += "<iframe id=\"" + panel.id + "\" class=\"embed-responsive-item\" src=\"" + url + panel.panel_url + "\" allowfullscreen></iframe>";
                    cardTag += "</div> </div> </div>";

                    panelUrl.set(panel.id, panel.panel_url);
                    return cardTag;
                }
            });

            $panelSelect.on('change', function (event) {
                $panelDataArea.text('');
                let queries = panelQueryMap.get(parseInt($(this).val()));
                for (let i = 0; i < queries.length; i++) {
                    if (queries[i].hide) {
                        continue;
                    }

                    let query = queries[i].api_query;
                    let queryVariables = query.match(/\$\w+/g);
                    if (queryVariables !== null) {
                        for (let variable of queryVariables) {
                            $thisSelector = $('#var-' + variable.replace("$", ""));
                            if ($thisSelector.val() !== undefined && $thisSelector.val() !== null) {
                                query = query.replace(new RegExp("\\" + variable, "g"), $thisSelector.val());
                            } else {
                                query = query.replace(new RegExp("\\" + variable, "g"), ".*");
                            }
                        }
                        console.log(query);
                    }
                    let timestamp = new Date().getTime() / 1000;
                    let url = "http://10.142.11.170:30089" + query + "&start=" + (timestamp - 60) + "&end=" + timestamp + "&step=15";
                    console.log(url);
                    $.get(url)
                        .done(function (data) {
                            console.log(data);
                            $panelDataArea.text($panelDataArea.text() + JSON.stringify(data, null, '  '));
                            document.querySelectorAll('pre > code').forEach(function (el) {
                                hljs.highlightBlock(el);
                            });
                        })
                        .fail(function () {
                            alert("조회 실패")
                        })
                        .always(function (data) {
                        });
                }
            });

            $(document).on("change", "select[name^='var']", function(event){
                let targetName = event.target.name.replace("var-", "");

                for (let [key, item] of variableMap) {
                    if (targetName === key || item.ref_fields.length === 0) {
                        continue;
                    }

                    let refFields = item.ref_fields;
                    let query = item.api_query;
                    for (let refField of refFields) {
                        let targetValue = $("#var-" + refField).val();
                        if (targetValue === null) {
                            break;
                        }
                        query = query.replace(new RegExp("\\"+"$"+refField, "g"), targetValue);
                    }
                    if (query.indexOf("$") < 0) {
                        let url = "http://10.142.11.170:30089/api/v1/query?query=" + query;
                        let currentTime = new Date().getTime() / 1000;
                        url += `&start=${currentTime - 300}&end=${currentTime}`;
                        console.log("prometheus api url : " + url);
                        $.get(url)
                            .done(function (data) {
                                console.log(data);
                                let results = data.data.result;
                                let metricName = item.api_query_metric_label;

                                let $thisSelector = $("#var-" + key);
                                $thisSelector.text('');

                                if (item.includeAll) {
                                    // 프로메테우스 api에서는 item.allValue를 이용해야 함.
                                    // $thisSelector.append("<option value='" + item.allValue + "'>All</option>");
                                    $thisSelector.append("<option value='All'>All</option>");
                                }

                                for (let result of results) {
                                    $("#var-"+key).append("<option value='" + result.metric[metricName] + "'>" + result.metric[metricName] + "</option>");
                                }

                                $(document).find('iframe').each(function (item) {
                                    let panelId = $(this).attr('id');
                                    var panelSrc = panelUrl.get(parseInt(panelId));

                                    $(document).find("select[name^='var']").each(function (v) {
                                        if ($(this).val() !== undefined && $(this).val() !== null) {
                                            panelSrc += "&" + $(this).attr('id') + "=" + $(this).val();
                                        }
                                    });

                                    console.log(panelSrc);
                                    $(this).attr('src', dashboardUrl + panelSrc);
                                });
                            })
                            .fail(function () {
                                alert("조회 실패");
                            })
                            .always(function (data) {
                            });
                    }
                }

            });


        });
    </script>
</div>
</body>
</html>