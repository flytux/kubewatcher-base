<!DOCTYPE html>
<html lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div layout:fragment="content" th:remove="tag">
    <th:block th:replace="layout/header :: header(${page?.nav})"/>
    <div id="main_contents">
        <!-- [Roles] start -->
        <div class="row">
            <div class="main_title_top"><i class="feather icon-chevrons-right"></i> Roles
                <div class="dropdown d_ib f_r">
                        <button class="btn btn-md btn-outline-white" id="btnModify"><i class="feather icon-file-text"></i> 저장 </button>
                        <button class="btn btn-md btn-outline-white" id="btnNew"><i class="feather icon-file-text"></i> NEW </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="box_panel">
                <div class="box_panel-total">
                    Rule : <span th:text="${#arrays.isEmpty(pageRuleList) ? '0' : pageRuleList.size()-1}" class="point pr_10"></span>
                </div>
                    <table class="box_table-body role_table">
                        <thead>
                            <tr>
                                <th>Page ID</th>
                                <th>화면명</th>
                                <th:block th:each="rule : ${ruleList}">
                                    <th th:text="${rule.rulename}" id="ruleList"></th>
                                </th:block>
                            </tr>
                        </thead>
                        <tbody id="ruleTbody">
                        </tbody>
                    </table>
            </div>

        </div>
<!--        <div class="text-center">-->
<!--            <div class="row text-center pt_15"><button class="btn btn-save">저 장</button></div>-->
<!--        </div>-->
        <!-- [Roles] End-->

        <!-- [Modal] start -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" >
            <div class="modal-dialog modal-lg" style="width:765px;">
                    <div class="modal-content">
                        <div class="modal-title_box">
                            <div class="modal-title">
                                <button type="button" class="close px-3" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <div class="f_r"><button class="btn_save_i feather icon-save" id="btnInsert"></button></div>
                                <span id="myModalLabel">Role</span>
                            </div>
                        </div>
                        <div class="modal-nbody">
                            <div class="table-title">
                                Role
                            </div>
                            <div class="row">
                                <table class="table-nt">
                                    <tr>
                                        <th>Role</th>
                                        <td>
                                            <input type="text" id="rolename" name="rolename" style="width:100%;" >
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Description</th>
                                        <td>
                                            <input type="text" id="description" name="description" style="width:100%;" >
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
        <!-- [Modal] End -->
    </div>
    <script type="text/javascript" th:inline="javascript">

        let pageRuleList = [[${pageRuleList}]],
            ruleList = [[${ruleList}]];

        $(document).ready(function () {
            var html = "";
            var pageList = new Array();
            pageList = Object.keys(pageRuleList[0]);

            for (var i = 0; i < pageList.length; i++) {
                html += '<tr>';
                html += '   <td>'+pageList[i]+'</td>';
                html += '   <td>'+pageRuleList[0][pageList[i]]+'</td>';
                for (var j = 1; j <= ruleList.length; j++){
                    var ruleListName = 'ruleList-' + ruleList[j-1].rulename;
                    html += ' <td><input name="' + ruleList[j-1].rulename + '" type="checkbox" ';
                    if(pageRuleList[j][pageList[i]] === '1') {
                        html += 'checked="checked"';
                    }
                    html += '>';
                 }
                html += '</tr>';
            }
            $("#ruleTbody").append(html);

        });

        // btnNew event
        $(document).on("click", "#btnNew", function(event){
            $('#myModal').modal();
        });

        // btnModify event
        $(document).on("click", "#btnModify", function(event){
            var rule = new Array();
            var ruleName = new Array();

            for(var i = 0; i < ruleList.length; i++ ){
                var strRule = "";
                var chkRule = $("input:checkbox[name='" + ruleList[i].rulename + "']");
                ruleName[i] = ruleList[i].rulename;
                for(var j = 0; j < chkRule.length; j++){
                    if($(chkRule[j]).is(":checked")){
                        strRule += "1";
                    } else {
                        strRule += "0";
                    }
                }
                rule[i] = strRule;
             }

            var msg = confirm( "저장하시겠습니까?" );
            if (msg === true) {
                $.ajax({
                    url : "/security/roles/user-role-management/modify",
                    data : {
                        'rolenameList' : ruleName,
                        'ruleList' : rule
                    },
                    traditional : true,
                    contentType : "application/json",
                    success : function (data){
                        alert('저장이 완료되었습니다.');
                        $('#myModal').hide();
                        $(location).attr('href', '/security/roles/user-role-management')
                    },
                    error: function (e) {
                        if (e.status === 401) {
                            $(location).attr('href', '/login?logout')
                        }
                    }
                });
           } else if (msg === false) {
               return;
           }
        });

        // btnInsert event
        $(document).on("click", "#btnInsert", function(event){
                let rolename = $("#rolename").val();
                let description = $("#description").val();
                var strRule = "";

                for (var i = 0; i < Object.keys(pageRuleList[0]).length; i++) {
                    strRule += "0";
                }

                if (rolename === '') {
                    alert('role이 입력되지 않았습니다.');
                    return;
                }

                if (description === '') {
                    alert('description이 입력되지 않았습니다.');
                    return;
                }

                var msg = confirm( "등록하시겠습니까?" );
                if (msg === true) {
                    $.ajax({
                        url : "/security/roles/user-role-management/save",
                        data : {
                            'rulename' : rolename,
                            'description' : description,
                            'rule' : strRule
                        },
                        success : function(data){
                          alert('등록이 완료되었습니다.');
                          $('#myModal').hide();
                          $(location).attr('href', '/security/roles/user-role-management')
                        },
                        error: function (e) {
                            if (e.status === 401) {
                                $(location).attr('href', '/login?logout')
                            }
                        }
                    });
               } else if (msg === false) {
                   return;
               }
        });

        // modal reset
        $('#myModal').on('hidden.bs.modal', function (e) {
            $('#rolename').val('');
            $('#description').val('');
        });

    </script>
</div>
</body>
</html>